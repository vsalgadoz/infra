---
- hosts: Proxmox
  tasks:
    - name: Validar que no exista '{{ vname }}'
      proxmox_kvm:
        api_user: root@pam
        api_password: RpcYoHi6Kb9y
        api_host: '{{ proxmox_server }}'
        name: '{{ vname }}'
        node: '{{ proxmox_node }}'
        state: current
      register: result
      ignore_errors: True
              
    - name: Clonar del source hacia '{{ vname }}'
      proxmox_kvm:
        api_user    : root@pam
        api_password: RpcYoHi6Kb9y
        api_host    : '{{ proxmox_server }}'
        clone       : '{{ source }}'   # The VM source
        name        : '{{ vname }}'
        node        : '{{ proxmox_node }}'
        storage     : local
        format      : qcow2
        timeout     : 500  # Note: The task can take a while. Adapt
        
    - name: Arrancar la maquina virtual recien creada '{{ vname }}'
      proxmox_kvm:
         api_user: root@pam
         api_password: RpcYoHi6Kb9y
         api_host: '{{ proxmox_server }}'
         name: '{{ vname }}'
         node: '{{ proxmox_node }}'
         state      : started
         
    - name: Habilitar ejecuci√≥n de comandos
      shell: ID=$(qm list | grep -Ei "{{ vname }}" | awk '{print $1}'); IF=$(qm guest exec $ID -- nmcli -t device | jq -r '."out-data"' | grep -Ei "ethernet" | head -1 | cut -d ":" -f 1); qm guest exec $ID -- sed -ie 's/,qemu-exec,qemu-exec-status//g' /etc/sysconfig/qemu-ga
      
    - name: Reinciar Agente
      systemd: 
        name: qemu-guest-agent
        state: restarted      
   
                                     
        
     
